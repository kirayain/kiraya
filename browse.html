<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiraya | Browse Rentals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-animate { opacity: 0; transform: translateY(20px); transition: all 0.6s ease-out; }
        .scroll-animate.show { opacity: 1; transform: translateY(0); }
        .highlight-card { animation: glow 2s ease-in-out 2; border: 3px solid #10b981 !important; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 15px #10b981; } 50% { box-shadow: 0 0 30px #10b981; } }
        .countdown { font-size: 0.875rem; font-weight: 600; color: #dc2626; }
        .expired { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-lg sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="text-3xl font-bold text-blue-700">Kiraya</div>
            <a href="index.html" class="text-blue-600 hover:underline">Home</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8">Browse Rentals</h1>
        <div id="rental-listings" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- Cards injected here -->
        </div>
    </main>

    <script>
        // Indian Time (IST) = UTC + 5:30
        const getIndianTime = () => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            return new Date(utc + (5.5 * 3600000));
        };

        const loadListings = () => {
            let listings = JSON.parse(localStorage.getItem('kirayaListings')) || [];
            const now = getIndianTime().getTime();
            const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);

            // Remove expired
            listings = listings.filter(i => i.timestamp >= oneWeekAgo);
            localStorage.setItem('kirayaListings', JSON.stringify(listings));

            renderListings(listings, now);
        };

        const renderListings = (listings, now) => {
            const container = document.getElementById('rental-listings');
            container.innerHTML = '';
            if (!listings.length) {
                container.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><p class="text-xl text-gray-600">No rentals available.</p></div>`;
                return;
            }

            const lastId = localStorage.getItem('lastListedItemId');

            listings.forEach(item => {
                const expiryTime = item.timestamp + (7 * 24 * 60 * 60 * 1000);
                const timeLeft = expiryTime - now;

                const card = document.createElement('div');
                card.className = `scroll-animate bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition ${item.id == lastId ? 'highlight-card' : ''} ${timeLeft <= 0 ? 'expired' : ''}`;
                card.dataset.id = item.id;

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                const countdownHTML = timeLeft > 0
                    ? `<div class="countdown">Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s</div>`
                    : `<div class="countdown">Expired</div>`;

                card.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover">
                    <div class="p-5 space-y-2">
                        <h3 class="text-lg font-bold text-gray-900 truncate">${item.name}</h3>
                        <p class="text-sm text-gray-600">
                            <strong>Phone:</strong> 
                            <a href="tel:${item.ownerPhone}" class="text-blue-600 hover:underline">${item.ownerPhone}</a>
                        </p>
                        <p class="text-sm text-gray-600">
                            <strong>Location:</strong> ${item.city}, ${item.pincode}
                        </p>
                        ${countdownHTML}
                        <div class="flex justify-between items-center pt-2 border-t">
                            <p class="text-xl font-bold text-blue-700">â‚¹${item.price}<span class="text-sm font-normal text-gray-500">/day</span></p>
                            <button onclick="deleteItem('${item.id}', '${item.deletePassword}')" class="text-red-600 text-sm font-medium hover:underline">Remove</button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            if (lastId) {
                setTimeout(() => {
                    const el = document.querySelector('.highlight-card');
                    el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    localStorage.removeItem('lastListedItemId');
                }, 500);
            }

            setupScrollAnimation();
            updateCountdowns(); // Start live timer
        };

        // Live countdown update every second
        const updateCountdowns = () => {
            const now = getIndianTime().getTime();
            document.querySelectorAll('.countdown').forEach(el => {
                const card = el.closest('[data-id]');
                if (!card) return;
                const id = card.dataset.id;
                const listings = JSON.parse(localStorage.getItem('kirayaListings')) || [];
                const item = listings.find(i => i.id == id);
                if (!item) return;

                const timeLeft = item.timestamp + (7 * 24 * 60 * 60 * 1000) - now;
                if (timeLeft <= 0) {
                    el.innerHTML = 'Expired';
                    card.classList.add('expired');
                    return;
                }

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                el.innerHTML = `Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
            });

            setTimeout(updateCountdowns, 1000);
        };

        window.deleteItem = (id, correctPass) => {
            const pass = prompt('Enter 6-digit delete password:');
            if (pass === correctPass) {
                let listings = JSON.parse(localStorage.getItem('kirayaListings')) || [];
                listings = listings.filter(i => i.id != id);
                localStorage.setItem('kirayaListings', JSON.stringify(listings));
                loadListings();
            } else {
                alert('Wrong password!');
            }
        };

        const setupScrollAnimation = () => {
            const obs = new IntersectionObserver(es => {
                es.forEach(e => {
                    if (e.isIntersecting) {
                        setTimeout(() => e.target.classList.add('show'), 50);
                        obs.unobserve(e.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.scroll-animate').forEach(c => obs.observe(c));
        };

        // Load on start
        loadListings();
    </script>
</body>
</html>
